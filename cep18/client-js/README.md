# `casper-cep18-js-client`

This JavaScript client gives you an easy way to install and interact with the Casper CEP-18 contract.

## Installation

Run this command to install the client:

```bash
npm install cep18-js-client
```

Import the contract in your code:

`import { CEP18Client } from 'casper-cep18-js-client'`

If you want to install it, look at the `install` method and all of the possible configuration options (`InstallArgs`).

If you want to start working with a previously installed contract, use the `setContractHash(contractHash)` method.

## Development

Before installing the node modules, make sure the contract Wasm is generated by running the following in the CEP folder:

```bash
make build-contracts
```

After generating the Wasm file, you can install the client, and the Wasm will be automatically bundled.

```bash
npm install && npm run generate:wasm
```

---

> The `casper-cep18-js-client` requires `casper-js-sdk` and `@make-software/ces-js-parser` as a peer dependency.

> **IMPORTANT:** The class Client in client.ts is duplicated in every CEP JS client. Any modifications made to this class must be reflected across all instances of CEP clients to ensure consistency. Be sure to update all relevant CEP JS clients whenever changes are made to this class.

## Examples and E2E Tests

In this project, you'll find two important directories that help demonstrate and test the functionality of the code:

### `examples/`

This directory contains example scripts that showcase how to use the various features of the project. Files like `events.ts`, `usage.ts`, `install.ts`, and `upgrade.ts` provide practical implementations, illustrating the intended usage in different scenarios. These examples are helpful for understanding how to integrate and utilize the core functionalities.

### `tests/e2e/`

This directory contains end-to-end (E2E) tests, which are designed to verify that the CEP behaves as expected in a real-world environment. Files like `usage.test.ts`, `install.test.ts`, `events.test.ts`, and `upgrade.test.ts` ensure that the features demonstrated in the `examples/` directory are functioning correctly, and provide confidence that the CEP performs as intended through various test cases.

---

Together, these directories serve as both guides and validation tools—**examples** illustrate how to use the CEP, while **E2E tests** ensure everything works seamlessly.

## Usage Examples

Create an instance of the CEP-18 client:

```ts
import {
  CEP18Client,
  ContractWASM as wasm,
  EVENTS_MODE,
  type InstallArgs,
  type TransactionParams,
  type TransactionResult
} from 'casper-cep18-js-client';

const RPC_URL = 'http://localhost:11101/rpc';
const SSE_URL = 'http://localhost:18101/events'; // optional can be set later
const CHAIN_NAME = 'casper-net-1'; // optional can be set later or per query

const cep18 = new CEP18Client(RPC_URL, SSE_URL, CHAIN_NAME);
```

Send a transaction to install the contract:

```ts
const params: TransactionParams = {
  wasm,
  sender: sender.publicKey, // Public Key
  paymentAmount,
  signingKeys: [sender] // Private Key
};

const args: InstallArgs = {
  name: 'TEST_CEP18',
  symbol: 'CEP18',
  decimals: 9,
  totalSupply: String(200_000_000_000),
  eventsMode: EVENTS_MODE.CES,
  enableMintAndBurn: true
};

const transactionResult: TransactionResult = await cep18.install({
  params,
  args,
  waitForTransactionProcessed: true // optional, waits for transaction process from SSE if SSE_URL is set
});
```

Set the contract hash (a unique identifier for the network):

```ts
cep18.setContractHash(
  'hash-c2402c3d88b13f14390ff46fde9c06b8590c9e45a9802f7fb8a2674ff9c1e5b1'
);
```

You can retrieve token information by calling these methods:

```ts
const name = await cep18.name();

const symbol = await cep18.symbol();

const totalSupply = await cep18.totalSupply();

const decimals = await cep18.decimals();

const eventsMode = await cep18.eventsMode();

const isMintAndBurnEnabled = await cep18.isMintAndBurnEnabled();
```

**Transfers**

Sends a transaction to transfer some tokens from the direct caller to a recipient:

```ts
const params: TransactionParams = {
  sender: owner.publicKey,
  paymentAmount: String(5_000_000_000),
  signingKeys: [owner]
};

const transferArgs: TransferArgs = {
  recipient: ali.publicKey,
  amount: String(1_000_000_000)
};

const transferResult = await cep18.transfer({
  params,
  args: transferArgs,
  waitForTransactionProcessed: true
});
```

Sends a transaction to transfer from an account owner to a recipient(bob), given that the direct caller (ali) has been previously approved to spend the specified amount on behalf of the owner:

```ts
const params = {
  sender: ali.publicKey,
  paymentAmount: String(5_000_000_000),
  signingKeys: [ali]
};

const transferFromArgs: TransferFromArgs = {
  owner: owner.publicKey,
  recipient: bob.publicKey,
  amount: String(2_000_000_000)
};

const transferFromResult = await cep18.transferFrom({
  params,
  args: transferFromArgs,
  waitForTransactionProcessed: true
});
```

**Balances**

Request the balance of an account with _balanceOf_:

```ts
const balance = await cep18.balanceOf(owner.publicKey);
```

**Approvals**

Sends a transaction to allow a spender (ali) to transfer up to a number of the direct caller’s tokens (owner):

```ts
const params: TransactionParams = {
  sender: owner.publicKey,
  paymentAmount: String(5_000_000_000),
  signingKeys: [owner]
};

const approveArgs: ApproveArgs = {
  spender: ali.publicKey,
  amount: String(5_000_000_000)
};

const approveResult = await cep18.approve({
  params,
  args: approveArgs,
  waitForTransactionProcessed: true
});
```

**Allowances**

Return the number of owner’s tokens allowed to be spent by spender (ali):

```ts
const allowances = await cep18.allowances(
  owner.publicKey,
  ali.publicKey
);
```

To increase or decrease the spender's allowance, use the following methods:

```ts
const increaseAllowanceResult = await client.increaseAllowance({
  params: {
    sender: owner.publicKey,
    paymentAmount: String(5_000_000_000),
    signingKeys: [owner]
  },
  args: {
    spender: ali.publicKey,
    amount: String(2_000_000_000)
  },
  waitForTransactionProcessed: true
});
```

```ts
const decreaseAllowanceResult = await client.decreaseAllowance({
  params: {
    sender: owner.publicKey,
    paymentAmount: String(5_000_000_000),
    signingKeys: [owner]
  },
  args: {
    spender: ali.publicKey,
    amount: String(2_000_000_000)
  },
  waitForTransactionProcessed: true
});
```

> The `mint`, `burn`, and `changeSecurity` deploy may fail if mint and burn is disabled in the contract. **You can only enable mint and burn when installing the contract.** You can check mint and burn is enabled by running
>
> ```ts
> const isMintAndBurnEnabled = await cep18.isMintAndBurnEnabled();
> ```

**Minting Tokens**

Mint tokens and assign them to a recipient (ali):

```ts
const params: TransactionParams = {
  sender: owner.publicKey,
  paymentAmount: String(5_000_000_000),
  signingKeys: [owner]
};

const mintArgs: MintArgs = {
  owner: ali.publicKey,
  amount: String(10_000_000_000)
};
const mintResult = await cep18.mint({
  params,
  args: mintArgs,
  waitForTransactionProcessed: true
});
```

**Burning Tokens**

Burn tokens and reduce them from the owner's account:

```ts
const params = {
  sender: ali.publicKey,
  paymentAmount: String(5_000_000_000),
  signingKeys: [ali]
};

const burnArgs: BurnArgs = {
  owner: ali.publicKey,
  amount: String(10_000_000_000)
};
const burnResult = await cep18.burn({
  params,
  args: burnArgs,
  waitForTransactionProcessed: true
});
```

**Changing User Security**

```ts
const minterList = [ali.publicKey];

const params: TransactionParams = {
  sender: owner.publicKey,
  paymentAmount: String(5_000_000_000),
  signingKeys: [owner]
};

const changeSecurityArgs: ChangeSecurityArgs = {
  minterList: newMinterList
};

const changeSecurityResult = await client.changeSecurity({
  params,
  args: changeSecurityArgs,
  waitForTransactionProcessed: true
});
```

**Changing Events Mode**

```ts
const eventsMode = EVENTS_MODE.Native;

const params: TransactionParams = {
  sender: owner.publicKey,
  paymentAmount: String(3_000_000_000),
  signingKeys: [owner]
};

const changeEventsModeArgs: ChangeEventsModeParams = {
  params,
  args: { eventsMode },
  waitForTransactionProcessed: true
};

const changeEventsModeResult = await client.changeEventsMode(
  changeEventsModeArgs
);
```

# Environment Variables for Casper CEP-18 Integration

This `.env` file contains essential environment variables for configuring the examples and e2e tests, including RPC and SSE endpoints, private key handling, and cryptographic settings.

## Configuration Variables

| Variable Name | Description |
| --- | --- |
| `RPC_URL` | The URL of the Casper JSON-RPC server used for interacting with the blockchain. Defaults to `http://localhost:11101/rpc`. |
| `SSE_URL` | The URL of the Casper SSE (Server-Sent Events) endpoint for real-time event streaming. Defaults to `http://localhost:18101/events`. |
| `CHAIN_NAME` | The name of the Casper blockchain network. Defaults to `casper-net-1`. |
| `PRIVATE_KEY_FAUCET` | The private key of the faucet account. Can be a **file path**, a **PEM-encoded base64 string**, or a **raw base64 key**. |
| `PRIVATE_KEY_USER_1` | The private key of the first user. Can be a **file path**, a **PEM-encoded base64 string**, or a **raw base64 key**. |
| `PRIVATE_KEY_USER_2` | The private key of the second user. Can be a **file path**, a **PEM-encoded base64 string**, or a **raw base64 key**. |
| `SECRET_KEY_NAME` | The default filename for private keys when using directory-based paths. Defaults to `secret_key.pem`. |
| `SECRET_KEY_ALGO` | The cryptographic algorithm used for private keys. Defaults to `ED25519`, unless `SECRET_KEY_ALGO` is set to `SECP256K1`. |

Automatically detects whether a provided private key is a **file path**, a **PEM-encoded base64 string**, or a **raw base64 key**.

### 1. Using a File Path

If `PRIVATE_KEY_FAUCET`, `PRIVATE_KEY_USER_1`, or `PRIVATE_KEY_USER_2` is set to a valid **file path**, the system will read the file and extract the key.

Example:

```env
PRIVATE_KEY_FAUCET=/casper/casper-nctl/assets/faucet/secret_key.pem
```

or, if the filename is omitted, it defaults to `SECRET_KEY_NAME`:

```env
PRIVATE_KEY_FAUCET=/casper/casper-nctl/assets/faucet/
```

### 2. Using a PEM-Encoded Base64 Key

You can also provide a full **PEM-formatted** private key directly in the `.env` file:

```env
PRIVATE_KEY_FAUCET=-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBg...\n-----END PRIVATE KEY-----
```

Will detect this format and use it as-is.

### 3. Using a Raw Base64 Key

Alternatively, you can provide a **raw base64-encoded key** without PEM formatting:

```env
PRIVATE_KEY_FAUCET=nMIIEvQIBADANBg...
```

If the system detects a raw base64 key, it will automatically format it into the correct PEM structure before use.

## Example `.env` File

```
RPC_URL=http://127.0.0.1:11101/rpc
SSE_URL=http://127.0.0.1:18101/events
CHAIN_NAME=casper-net-1

PRIVATE_KEY_FAUCET=/casper/casper-nctl/assets/faucet/
PRIVATE_KEY_USER_1=-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBg...\n-----END PRIVATE KEY-----
PRIVATE_KEY_USER_2=nMIIEvQIBADANBg...
```

## Security Considerations

- Never commit private keys to version control.
- Use environment variables or secure storage for private keys.
- If using base64 PEM keys, ensure they are stored securely.

## Available Commands

The following commands are available in the `scripts` section of the project to assist with various tasks such as linting, testing, building, and running examples.

### Build and Clean

- **`clean`**: Removes the `./dist` directory. This is often used to clear out previous builds.

  ```bash
  npm run clean
  ```

- **`prebuild`**: Runs the `clean` command as a preparatory step before building.

  ```bash
  npm run prebuild
  ```

- **`build`**: Builds the project using `tsup`, outputting both ESM and CJS formats, as well as generating type definitions and minifying the code.
  ```bash
  npm run build
  ```

### Testing

- **`test:unit`**: Runs unit tests using Vitest on the `tests/unit` directory.

  ```bash
  npm run test:unit
  ```

- **`test:e2e`**: Runs end-to-end (E2E) tests using Vitest on the `tests/e2e` directory.

  ```bash
  npm run test:e2e
  ```

- **`test`**: Runs both unit tests and E2E tests. It is a combination of `test:unit` and `test:e2e`.

  ```bash
  npm run test
  ```

- **`test:e2e:install`**: Runs the E2E tests specific to the `install.test.ts` file.

  ```bash
  npm run test:e2e:install
  ```

- **`test:e2e:upgrade`**: Runs the E2E tests specific to the `upgrade.test.ts` file.

  ```bash
  npm run test:e2e:upgrade
  ```

- **`test:e2e:usage`**: Runs the E2E tests specific to the `usage.test.ts` file.

  ```bash
  npm run test:e2e:usage
  ```

- **`test:e2e:events`**: Runs the E2E tests specific to the `events.test.ts` file.
  ```bash
  npm run test:e2e:events
  ```

### Examples

- **`example:install`**: Runs the `install.ts` example to demonstrate the installation process.

  ```bash
  npm run example:install
  ```

- **`example:upgrade`**: Runs the `upgrade.ts` example to demonstrate the upgrade process.

  ```bash
  npm run example:upgrade
  ```

- **`example:usage`**: Runs the `usage.ts` example to demonstrate general usage of the project.

  ```bash
  npm run example:usage
  ```

- **`example:events`**: Runs the `events.ts` example to demonstrate the events functionality.
  ```bash
  npm run example:events
  ```

### Linting and Formatting

- **`lint`**: Runs ESLint on the `src/` directory and fails if there are any warnings.

  ```bash
  npm run lint
  ```

- **`lint:write`**: Runs ESLint on the `src/` directory and automatically fixes issues where possible.

  ```bash
  npm run lint:write
  ```

- **`type-check`**: Runs TypeScript’s compiler in "noEmit" mode to check for type errors without generating any output files.

  ```bash
  npm run type-check
  ```

- **`format`**: Formats the source code in the `src/` directory using Prettier.
  ```bash
  npm run format
  ```

### WebAssembly Generation

- **`generate:wasm`**: Copies and converts WebAssembly files from above CEP contract build using a custom script defined in `src/scripts/copy-and-convert-wasms.ts`.
  ```bash
  npm run generate:wasm
  ```

---

These commands cover a wide range of tasks to support development, testing, and building. Feel free to use the relevant ones based on the task at hand.

## Event Handling

# CEP-18 Event Handling

CEP-18 tokens support the [Casper Event Standard (CES)](https://github.com/make-software/casper-event-standard), allowing event-based interactions. Tokens can be installed with or without event logging, as described [here](../cep18/README.md#eventsmode).

If a token is installed with `EventsMode` set to CES, you can listen for token events using the `EventStream` from the `casper-js-sdk`.

## Setting Up Event Streaming

To start listening for CEP-18 events, set up the `EventStream` as follows:

```ts
import { CEP18Client } from 'casper-cep18-js-client';

const cep18 = new CEP18Client(
  'http://localhost:11101/rpc', // RPC URL
  'http://localhost:18101/events', // SSE URL
  'casper-net-1' // Chain name
);

// Set the contract hash and start listening for events
cep18
  .setContractHash(
    'hash-0885c63f5f25ec5b6f3b57338fae5849aea5f1a2c96fc61411f2bfc5e432de5a'
  )
  .startEventStream();
```

## Listening for Events

You can subscribe to token events by attaching event listeners:

```ts
const listener = event => {
  console.log(event.name); // Example: 'Burn'
  console.log(event.data); // Event-specific data
};

cep18.on('Burn', listener);
```

## Removing Event Listeners

### Remove a Specific Listener

To remove a specific event listener, use `off()`:

```ts
cep18.off('Burn', listener);
```

### Remove All Listeners for an Event

To remove all listeners attached to a specific event:

```ts
cep18.removeListenersForEvent('Burn');
```

### Remove All Listeners

To remove all event listeners across all events:

```ts
cep18.removeAllListeners();
```

## Event Stream Lifecycle

### Starting the Event Stream

Call `startEventStream()` to begin listening for events:

```ts
cep18.startEventStream();
```

### Stopping the Event Stream

To stop listening for events, use:

```ts
cep18.stopEventStream();
```

Stopping the event stream will also prevent any new events from triggering listeners.

## Best Practices for Event Handling

- Ensure you stop the event stream when it is no longer needed to avoid unnecessary resource usage.
- Always remove event listeners that are no longer required using `off()`, `removeListenersForEvent()`, or `removeAllListeners()`.
- If you need to temporarily disable event handling, consider stopping the event stream instead of removing all listeners.
- Use the `ces-js-parser`'s event parser to efficiently decode event payloads.

## `waitForTransactionProcessed`

The `waitForTransactionProcessed` method waits for a transaction to be processed and resolves once the transaction is found. It also handles a timeout to prevent the operation from running indefinitely. Additionally, an optional SSE URL can be provided.

### Parameters:

- `transactionHash` (string): The hash of the transaction you want to wait for.
- `timeout` (number, optional): Timeout in milliseconds. Defaults to `defaulTransactionTimeout` if not provided.
- `sseUrl` (string, optional): Optional SSE URL. If provided, updates the client's SSE URL.

### Returns:

- A `Promise` that resolves to the `TransactionProcessedEvent` when the transaction is found.

### Throws:

- An `Error` if the transaction processing times out or if an error occurs during subscription.

---

## `getTransactionResult`

The `getTransactionResult` method retrieves and parses the transaction result for a given transaction hash.

If the transaction was not successful, this method throws:

- `ContractError` if the failure is due to an operational error.
- A generic `Error` containing the original error message for other failures.

### Parameters:

- `transactionHash` (string): The hash of the transaction to retrieve.

### Returns:

- A `Promise` resolving to the `InfoGetTransactionResult` containing transaction details.

### Throws:

- `ContractError` if the transaction failed due to an operational error.
- `Error` with the original error message if another failure occurs.

---

## Example Usage

```ts
// Example of using getTransactionResult:
try {
  const result = await client.getTransactionResult(transactionHash);
  console.log('Transaction result:', result);
} catch (error) {
  console.error('Error fetching transaction result:', error);
}

// Example of using waitForTransactionProcessed:
client
  .waitForTransactionProcessed(transactionHash, 5000)
  .then(event => {
    console.log('Transaction processed:', event);
    // Optionally fetch the transaction result after processing the event
    return client.getTransactionResult(transactionHash);
  })
  .then(result => {
    console.log('Transaction result after event:', result);
  })
  .catch(error => {
    console.error('Error processing transaction:', error);
  });
```

## Best Practices

- When using \`waitForTransactionProcessed\`, ensure that the timeout is set appropriately to avoid unnecessary waiting.
- Use \`getTransactionResult\` after the transaction has been processed if you need to fetch the result after the event is triggered.

## More examples

Additional examples are in available in the [examples](https://github.com/casper-ecosystem/cep18/tree/dev/client-js/examples), and [tests](https://github.com/casper-ecosystem/cep18/tree/dev/client-js/tests) directory.

## Testing

Unit and integration tests are available in the `client-js` directory.

First, you must clone the repository:

```bash
git clone https://github.com/casper-ecosystem/cep18.git
```

Go to the `client-js` directory:

```bash
cd client-js
```

Intall the node modules using the following:

```bash
npm install && npm run generate:wasm
```

Run unit tests:

```bash
npm run test:unit
```

You can test the script by running a [local network](https://github.com/casper-network/casper-nctl/blob/dev/docs/setup.md). After setting up the local network, run the end-to-end integration tests with this command:

```bash
npm run test:e2e
```
